<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Source Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style for the loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden transition-opacity duration-300">
        <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl">
            <div class="spinner mb-4"></div>
            <p class="text-lg font-semibold text-gray-800">Analyzing Repository Data...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                Project Health Dashboard
            </h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sidebar: Search & Watch List (Col 1) -->
            <aside class="lg:col-span-1 space-y-6">

                <!-- Repository Search Card -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Find a Repository</h2>
                    <div class="space-y-4">
                        <input type="text" id="repo-owner" placeholder="Owner (e.g., facebook)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <input type="text" id="repo-name" placeholder="Name (e.g., react)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <button onclick="loadRepoMetrics()" class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                            Analyze Repository
                        </button>
                    </div>
                </div>

                <!-- Watched Repositories Card (Firestore Data) -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Watched Repositories</h2>
                    <ul id="watched-repos-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Content rendered by renderWatchedRepos() -->
                    </ul>
                </div>
            </aside>


            <!-- Main Dashboard Panel (Cols 2-4) -->
            <main class="lg:col-span-3 space-y-6">
                
                <!-- Current Repo Info Card -->
                <div class="card bg-white p-6 rounded-xl">
                    <div id="repo-header" class="flex justify-between items-start">
                        <h2 class="text-3xl font-bold text-gray-900" id="current-repo-title">
                            No Repository Selected
                        </h2>
                        <div class="flex space-x-3">
                            <a id="github-link-btn" target="_blank" class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-200 hidden cursor-pointer flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                View on GitHub
                            </a>
                            <button id="add-to-watch-btn" onclick="addToWatchedList()" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 hidden flex items-center">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9l-2-2H5z"></path></svg>
                                Watch
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-500 mt-1" id="repo-description">Enter a repository name to begin analysis.</p>
                </div>

                <!-- Key Metrics (KPIs) - Expanded -->
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-6">
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Total Open Issues</p>
                        <p id="kpi-issues" class="text-xl md:text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Last 7D Commits</p>
                        <p id="kpi-commits" class="text-xl md:text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-purple-500">
                        <p class="text-sm font-medium text-gray-500">Avg PR Merge Time</p>
                        <p id="kpi-pr-time" class="text-xl md:text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Stars</p>
                        <p id="kpi-stars" class="text-xl md:text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Primary Language</p>
                        <p id="kpi-language" class="text-xl md:text-3xl font-bold text-gray-900 mt-1 text-red-600 truncate">--</p>
                    </div>
                </div>

                <!-- Charts Section (2x2 Grid on Large Screens) -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                    <!-- Commit Activity Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Weekly Commit Activity</h3>
                        <div class="h-64">
                            <canvas id="commitActivityChart"></canvas>
                        </div>
                    </div>

                    <!-- Issue Flow Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Open vs. Closed Issues (Last 30 Days)</h3>
                        <div class="h-64">
                            <canvas id="issueFlowChart"></canvas>
                        </div>
                    </div>

                    <!-- PR Velocity Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Pull Request Merge Velocity</h3>
                        <div class="h-64">
                            <canvas id="prVelocityChart"></canvas>
                        </div>
                    </div>

                    <!-- NEW: Code Frequency Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Code Frequency (Additions/Deletions)</h3>
                        <div class="h-64">
                            <canvas id="codeFrequencyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Contributor Leaderboard -->
                <div class="card bg-white p-6 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Top Contributors (Last 90 Days)</h3>
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button id="sort-commits-btn" onclick="toggleContributorSort('commits')" class="py-2 px-4 text-sm font-medium rounded-l-lg border transition duration-150">
                                Commits
                            </button>
                            <button id="sort-loc-btn" onclick="toggleContributorSort('loc')" class="py-2 px-4 text-sm font-medium rounded-r-lg border transition duration-150">
                                LoC Changed
                            </button>
                        </div>
                    </div>
                    <div id="contributor-leaderboard" class="space-y-3">
                        <!-- Content rendered by renderContributorLeaderboard() -->
                        <p class="text-gray-400">Contributor data will appear here after analysis.</p>
                    </div>
                </div>

            </main>
        </div>
    </div>


    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let watchedRepos = [];
        let currentRepoData = { contributors: [] };
        let contributorSortKey = 'commits'; // Default sort key

        // Attach global functions to the window object so they can be called from HTML
        window.loadRepoMetrics = loadRepoMetrics;
        window.addToWatchedList = addToWatchedList;
        window.removeWatchedRepo = removeWatchedRepo;
        window.toggleContributorSort = toggleContributorSort;

        // --- Loading State Management ---

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }


        // --- Firebase Utilities ---

        /** Initializes Firebase and sets up the Auth state listener. */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Firestore features will be disabled.");
                    // Still mark auth as ready to allow the rest of the app to run
                    isAuthReady = true; 
                    return; 
                }
                
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        setupWatchedReposListener();
                    } else {
                        // Sign in anonymously if no token is provided
                        try {
                            if (authToken) {
                                await signInWithCustomToken(auth, authToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed, signing in anonymously as fallback:", error);
                            // Fallback if auth fails, use a random ID. Data won't persist across sessions if no auth token.
                            userId = crypto.randomUUID();
                            document.getElementById('user-id-display').textContent = `[Anonymous Session] User ID: ${userId.substring(0, 8)}...`;
                            isAuthReady = true;
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        /** Sets up a real-time listener for the user's watched repositories. */
        function setupWatchedReposListener() {
            if (!db || !userId) return;

            const reposPath = `/artifacts/${appId}/users/${userId}/watched_repos`;
            const q = collection(db, reposPath);

            onSnapshot(q, (snapshot) => {
                watchedRepos = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    watchedRepos.push({
                        id: doc.id,
                        owner: data.owner,
                        repo: data.repo,
                        fullName: `${data.owner}/${data.repo}`
                    });
                });
                renderWatchedRepos();
            }, (error) => {
                console.error("Error fetching watched repos:", error);
            });
        }

        /** Renders the watched repositories list in the sidebar. */
        function renderWatchedRepos() {
            const listElement = document.getElementById('watched-repos-list');
            listElement.innerHTML = ''; // Clear existing list

            if (watchedRepos.length === 0) {
                listElement.innerHTML = '<li class="text-sm text-gray-400 p-3">No repositories watched yet.</li>';
                return;
            }

            watchedRepos.forEach(repo => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-50 rounded-lg text-gray-700 cursor-pointer hover:bg-gray-100 transition duration-150 flex justify-between items-center group';
                
                // Click handler to load metrics for a watched repo
                li.onclick = () => {
                    // Pre-fill search boxes for clarity
                    document.getElementById('repo-owner').value = repo.owner;
                    document.getElementById('repo-name').value = repo.repo;
                    loadRepoMetrics(repo.owner, repo.repo);
                };

                li.innerHTML = `
                    <span class="font-medium">${repo.fullName}</span>
                    <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition duration-150 p-1" onclick="event.stopPropagation(); removeWatchedRepo('${repo.id}', '${repo.fullName}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                listElement.appendChild(li);
            });
        }


        // --- Data Fetching and Metrics Logic ---

        /**
         * Fetches data from the GitHub API and updates the dashboard.
         * @param {string} owner - The repository owner.
         * @param {string} repo - The repository name.
         */
        async function loadRepoMetrics(owner = null, repo = null) {
            const repoOwner = owner || document.getElementById('repo-owner').value.trim();
            const repoName = repo || document.getElementById('repo-name').value.trim();

            if (!repoOwner || !repoName) {
                // Use custom message instead of alert
                document.getElementById('repo-description').textContent = '⚠️ Please enter both repository owner and name to analyze.';
                return;
            }
            
            showLoading(); // Show loading spinner
            
            const fullName = `${repoOwner}/${repoName}`;
            document.getElementById('current-repo-title').textContent = `${fullName} (Analyzing...)`;
            document.getElementById('repo-description').textContent = 'Fetching and processing data from GitHub...';
            document.getElementById('add-to-watch-btn').classList.add('hidden');
            document.getElementById('github-link-btn').classList.add('hidden'); // Hide link button while loading

            // Reset current data
            currentRepoData.contributors = [];


            try {
                // --- MOCK API DATA FETCHING (To be replaced with actual GitHub API calls) ---
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Mock Repository Metadata
                const avgPrMergeTimeDays = Math.floor(Math.random() * 10) + 1; // 1 to 10 days
                const mockMetadata = {
                    description: `A mock description for ${repoName}. This repository is used to demonstrate project health visualization.`,
                    stars: Math.floor(Math.random() * 100000) + 1000,
                    language: ['JavaScript', 'TypeScript', 'Python', 'Go'][Math.floor(Math.random() * 4)],
                    homepage: `https://github.com/${repoOwner}/${repoName}`,
                    avgPrMergeTime: avgPrMergeTimeDays
                };

                // Mock Chart and KPI data
                const mockCommitData = Array.from({ length: 12 }, () => Math.floor(Math.random() * 500) + 100);
                const mockIssueData = Array.from({ length: 30 }, () => ({
                    open: Math.floor(Math.random() * 20) + 5,
                    closed: Math.floor(Math.random() * 10) + 2
                }));
                const mockPrData = Array.from({ length: 12 }, () => ({
                    opened: Math.floor(Math.random() * 80) + 10,
                    merged: Math.floor(Math.random() * 60) + 5
                }));
                // NEW: Mock Code Frequency Data
                const mockCodeFrequencyData = Array.from({ length: 12 }, () => ({
                    additions: Math.floor(Math.random() * 5000) + 500,
                    deletions: Math.floor(Math.random() * 2000) + 100
                }));


                // Mock Contributor Data (user, commits, lines_of_code)
                const mockContributorData = [
                    { user: 'core-dev-1', commits: Math.floor(Math.random() * 800) + 100, loc_changed: Math.floor(Math.random() * 50000) + 10000 },
                    { user: 'maintainer-2', commits: Math.floor(Math.random() * 400) + 50, loc_changed: Math.floor(Math.random() * 20000) + 5000 },
                    { user: 'feature-contributor', commits: Math.floor(Math.random() * 200) + 20, loc_changed: Math.floor(Math.random() * 10000) + 1000 },
                    { user: 'bug-fixer', commits: Math.floor(Math.random() * 100) + 10, loc_changed: Math.floor(Math.random() * 5000) + 500 },
                    { user: 'doc-writer', commits: Math.floor(Math.random() * 50) + 5, loc_changed: Math.floor(Math.random() * 1000) + 100 },
                ];
                currentRepoData.contributors = mockContributorData; // Save data globally

                // --- Process and Update UI ---
                
                const openIssues = mockIssueData.reduce((acc, d) => acc + d.open, 0);
                const last7DaysCommits = mockCommitData[mockCommitData.length - 1] / 3; 

                document.getElementById('current-repo-title').textContent = fullName;
                document.getElementById('repo-description').textContent = mockMetadata.description;
                
                // Update KPIs
                document.getElementById('kpi-issues').textContent = openIssues.toLocaleString();
                document.getElementById('kpi-commits').textContent = Math.round(last7DaysCommits).toLocaleString();
                document.getElementById('kpi-pr-time').textContent = `${mockMetadata.avgPrMergeTime} Days`;
                document.getElementById('kpi-stars').textContent = mockMetadata.stars.toLocaleString();
                document.getElementById('kpi-language').textContent = mockMetadata.language;
                
                // Set GitHub Link
                const githubLinkBtn = document.getElementById('github-link-btn');
                githubLinkBtn.setAttribute('href', `https://github.com/${repoOwner}/${repoName}`);
                githubLinkBtn.classList.remove('hidden');


                // Show watch button if not already watched
                const isWatched = watchedRepos.some(r => r.fullName.toLowerCase() === fullName.toLowerCase());
                const watchBtn = document.getElementById('add-to-watch-btn');
                if (!isWatched && isAuthReady) {
                    watchBtn.classList.remove('hidden');
                    watchBtn.dataset.owner = repoOwner;
                    watchBtn.dataset.repo = repoName;
                } else {
                    watchBtn.classList.add('hidden');
                }

                // Render Charts and Leaderboard
                renderCommitActivityChart(mockCommitData);
                renderIssueFlowChart(mockIssueData);
                renderPRVelocityChart(mockPrData);
                renderCodeFrequencyChart(mockCodeFrequencyData);
                
                // Render leaderboard using the default sort key
                renderContributorLeaderboard(currentRepoData.contributors);
                updateSortButtons();

            } catch (error) {
                document.getElementById('current-repo-title').textContent = `Error Loading ${fullName}`;
                document.getElementById('repo-description').textContent = `Could not fetch data. The repository might not exist or the API failed.`;
                console.error("Error loading metrics:", error);
            } finally {
                hideLoading(); // Hide loading spinner
            }
        }

        /** Toggles the sorting key for the contributor leaderboard and re-renders it. */
        function toggleContributorSort(key) {
            contributorSortKey = key;
            updateSortButtons();
            renderContributorLeaderboard(currentRepoData.contributors);
        }

        /** Updates the visual state of the contributor sort buttons. */
        function updateSortButtons() {
            const commitsBtn = document.getElementById('sort-commits-btn');
            const locBtn = document.getElementById('sort-loc-btn');

            if (contributorSortKey === 'commits') {
                commitsBtn.className = 'py-2 px-4 text-sm font-bold rounded-l-lg border-2 border-blue-600 bg-blue-500 text-white transition duration-150';
                locBtn.className = 'py-2 px-4 text-sm font-medium rounded-r-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-150';
            } else {
                commitsBtn.className = 'py-2 px-4 text-sm font-medium rounded-l-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-150';
                locBtn.className = 'py-2 px-4 text-sm font-bold rounded-r-lg border-2 border-purple-600 bg-purple-500 text-white transition duration-150';
            }
        }

        /** Renders the top contributors list, sorted by the current key. */
        function renderContributorLeaderboard(contributors) {
            const listElement = document.getElementById('contributor-leaderboard');
            listElement.innerHTML = ''; // Clear existing list

            if (contributors.length === 0) {
                listElement.innerHTML = '<p class="text-gray-400">No recent contributor data available.</p>';
                return;
            }

            // Sort logic
            const sortedContributors = [...contributors].sort((a, b) => {
                if (contributorSortKey === 'commits') {
                    return b.commits - a.commits;
                } else {
                    return b.loc_changed - a.loc_changed;
                }
            });

            // Display unit
            const unit = contributorSortKey === 'commits' ? 'Commits' : 'LoC Changed';
            const valueKey = contributorSortKey === 'commits' ? 'commits' : 'loc_changed';

            sortedContributors.forEach((contributor, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg transition duration-150 hover:bg-gray-100';
                
                const rankColor = index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-amber-700' : 'text-gray-500';

                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-bold w-6 text-center ${rankColor}">#${index + 1}</span>
                        <!-- Placeholder for user avatar -->
                        <div class="w-8 h-8 bg-blue-200 rounded-full flex items-center justify-center text-sm font-semibold text-blue-800">
                            ${contributor.user.charAt(0).toUpperCase()}
                        </div>
                        <span class="font-medium text-gray-800">${contributor.user}</span>
                    </div>
                    <span class="text-lg font-bold text-gray-700">${contributor[valueKey].toLocaleString()} ${unit}</span>
                `;
                listElement.appendChild(item);
            });
        }


        let commitChartInstance = null;
        function renderCommitActivityChart(data) {
            if (commitChartInstance) commitChartInstance.destroy();

            const ctx = document.getElementById('commitActivityChart').getContext('2d');
            
            // Generate mock labels (Last 12 weeks)
            const today = new Date();
            const labels = Array.from({ length: 12 }, (_, i) => {
                const date = new Date(today);
                date.setDate(today.getDate() - (11 - i) * 7); // Calculate the start of the week
                return `Week of ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            });

            commitChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Commits per Week',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue-500
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { 
                            grid: { display: false },
                            ticks: { autoSkip: true, maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });
        }

        let issueChartInstance = null;
        function renderIssueFlowChart(data) {
            if (issueChartInstance) issueChartInstance.destroy();

            const ctx = document.getElementById('issueFlowChart').getContext('2d');
            
            // Generate mock labels (Last 30 days)
            const labels = Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`);
            const openData = data.map(d => d.open);
            const closedData = data.map(d => d.closed);

            issueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Issues Opened',
                            data: openData,
                            borderColor: 'rgb(234, 88, 12)', // Orange-600
                            tension: 0.2,
                            fill: false,
                            pointRadius: 2
                        },
                        {
                            label: 'Issues Closed',
                            data: closedData,
                            borderColor: 'rgb(22, 163, 74)', // Green-600
                            tension: 0.2,
                            fill: false,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        let prChartInstance = null;
        function renderPRVelocityChart(data) {
            if (prChartInstance) prChartInstance.destroy();

            const ctx = document.getElementById('prVelocityChart').getContext('2d');
            
            // Generate mock labels (Last 12 weeks)
            const today = new Date();
            const labels = Array.from({ length: 12 }, (_, i) => {
                const date = new Date(today);
                date.setDate(today.getDate() - (11 - i) * 7);
                return `Week of ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            });
            
            const openedData = data.map(d => d.opened);
            const mergedData = data.map(d => d.merged);

            prChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PRs Opened',
                            data: openedData,
                            borderColor: 'rgb(147, 51, 234)', // Purple-600
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3
                        },
                        {
                            label: 'PRs Merged',
                            data: mergedData,
                            borderColor: 'rgb(5, 150, 105)', // Emerald-600
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { 
                            grid: { display: false },
                            ticks: { autoSkip: true, maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });
        }
        
        let codeFrequencyChartInstance = null;
        function renderCodeFrequencyChart(data) {
            if (codeFrequencyChartInstance) codeFrequencyChartInstance.destroy();

            const ctx = document.getElementById('codeFrequencyChart').getContext('2d');
            
            // Generate mock labels (Last 12 weeks)
            const today = new Date();
            const labels = Array.from({ length: 12 }, (_, i) => {
                const date = new Date(today);
                date.setDate(today.getDate() - (11 - i) * 7);
                return `Week ${12 - i}`; // Using week number for brevity in the chart
            });
            
            const additionsData = data.map(d => d.additions);
            const deletionsData = data.map(d => d.deletions * -1); // Deletions as negative values

            codeFrequencyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Additions (+)',
                            data: additionsData,
                            backgroundColor: 'rgba(4, 120, 87, 0.7)', // Emerald-700
                        },
                        {
                            label: 'Deletions (-)',
                            data: deletionsData,
                            backgroundColor: 'rgba(185, 28, 28, 0.7)', // Red-700
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            stacked: true,
                            beginAtZero: false,
                            grid: { display: false },
                            title: { display: true, text: 'Lines of Code' }
                        },
                        x: { 
                            stacked: true,
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        // --- Start Application ---
        window.addEventListener('load', () => {
            initializeFirebase();
            // Initialize button state
            updateSortButtons();
        });
    </script>

</body>
</html>
