<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open-Source Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for a polished look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                Project Health Dashboard
            </h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Sidebar: Search & Watch List (Col 1) -->
            <aside class="lg:col-span-1 space-y-6">

                <!-- Repository Search Card -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Find a Repository</h2>
                    <div class="space-y-4">
                        <input type="text" id="repo-owner" placeholder="Owner (e.g., facebook)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <input type="text" id="repo-name" placeholder="Name (e.g., react)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <button onclick="loadRepoMetrics()" class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md">
                            Analyze Repository
                        </button>
                    </div>
                </div>

                <!-- Watched Repositories Card (Firestore Data) -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Watched Repositories</h2>
                    <ul id="watched-repos-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Placeholder for Firestore data -->
                        <li class="p-3 bg-gray-50 rounded-lg text-gray-700 cursor-pointer hover:bg-gray-100 transition duration-150 flex justify-between items-center">
                            <span>octocat/Spoon-Knife</span>
                            <button class="text-red-400 hover:text-red-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </li>
                    </ul>
                </div>
            </aside>


            <!-- Main Dashboard Panel (Cols 2-4) -->
            <main class="lg:col-span-3 space-y-6">
                
                <!-- Current Repo Info Card -->
                <div class="card bg-white p-6 rounded-xl">
                    <div id="repo-header" class="flex justify-between items-start">
                        <h2 class="text-3xl font-bold text-gray-900" id="current-repo-title">
                            No Repository Selected
                        </h2>
                        <button id="add-to-watch-btn" onclick="addToWatchedList()" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-200 hidden">
                            + Watch
                        </button>
                    </div>
                    <p class="text-gray-500 mt-1" id="repo-description">Enter a repository name to begin analysis.</p>
                </div>

                <!-- Key Metrics (KPIs) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Total Open Issues</p>
                        <p id="kpi-issues" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Last 7 Days Commits</p>
                        <p id="kpi-commits" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                    <div class="card bg-white p-5 rounded-xl border-l-4 border-purple-500">
                        <p class="text-sm font-medium text-gray-500">Active Contributors</p>
                        <p id="kpi-contributors" class="text-3xl font-bold text-gray-900 mt-1">--</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <!-- Commit Activity Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Weekly Commit Activity</h3>
                        <div class="h-64">
                            <canvas id="commitActivityChart"></canvas>
                        </div>
                    </div>

                    <!-- Issue Flow Chart -->
                    <div class="card bg-white p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Open vs. Closed Issues (Last 30 Days)</h3>
                        <div class="h-64">
                            <canvas id="issueFlowChart"></canvas>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>


    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let watchedRepos = [];

        // Attach global functions to the window object so they can be called from HTML
        window.loadRepoMetrics = loadRepoMetrics;
        window.addToWatchedList = addToWatchedList;
        window.removeWatchedRepo = removeWatchedRepo;

        // --- Utility Functions for Firebase and Charts ---

        /** Initializes Firebase and sets up the Auth state listener. */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Firestore features will be disabled.");
                    return;
                }
                
                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        setupWatchedReposListener();
                    } else {
                        // Sign in anonymously if no token is provided
                        try {
                            if (authToken) {
                                await signInWithCustomToken(auth, authToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            // Fallback if auth fails, use a random ID but data won't persist across sessions
                            userId = crypto.randomUUID();
                            document.getElementById('user-id-display').textContent = `[Anonymous Session] User ID: ${userId.substring(0, 8)}...`;
                            isAuthReady = true;
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        /** Sets up a real-time listener for the user's watched repositories. */
        function setupWatchedReposListener() {
            if (!db || !userId) return;

            const reposPath = `/artifacts/${appId}/users/${userId}/watched_repos`;
            const q = collection(db, reposPath);

            onSnapshot(q, (snapshot) => {
                watchedRepos = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    watchedRepos.push({
                        id: doc.id,
                        owner: data.owner,
                        repo: data.repo,
                        fullName: `${data.owner}/${data.repo}`
                    });
                });
                renderWatchedRepos();
            }, (error) => {
                console.error("Error fetching watched repos:", error);
            });
        }

        /** Renders the watched repositories list in the sidebar. */
        function renderWatchedRepos() {
            const listElement = document.getElementById('watched-repos-list');
            listElement.innerHTML = ''; // Clear existing list

            if (watchedRepos.length === 0) {
                listElement.innerHTML = '<li class="text-sm text-gray-400 p-3">No repositories watched yet.</li>';
                return;
            }

            watchedRepos.forEach(repo => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-50 rounded-lg text-gray-700 cursor-pointer hover:bg-gray-100 transition duration-150 flex justify-between items-center group';
                
                // Click handler to load metrics for a watched repo
                li.onclick = () => loadRepoMetrics(repo.owner, repo.repo);

                li.innerHTML = `
                    <span class="font-medium">${repo.fullName}</span>
                    <button class="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition duration-150 p-1" onclick="event.stopPropagation(); removeWatchedRepo('${repo.id}', '${repo.fullName}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                listElement.appendChild(li);
            });
        }


        /**
         * Fetches data from the GitHub API and updates the dashboard.
         * @param {string} owner - The repository owner.
         * @param {string} repo - The repository name.
         */
        async function loadRepoMetrics(owner = null, repo = null) {
            const repoOwner = owner || document.getElementById('repo-owner').value.trim();
            const repoName = repo || document.getElementById('repo-name').value.trim();

            if (!repoOwner || !repoName) {
                alert('Please enter both repository owner and name.');
                return;
            }

            const fullName = `${repoOwner}/${repoName}`;
            document.getElementById('current-repo-title').textContent = `${fullName} (Loading...)`;
            document.getElementById('repo-description').textContent = 'Fetching data from GitHub...';
            document.getElementById('add-to-watch-btn').classList.add('hidden');

            try {
                // --- MOCK API DATA FETCHING ---
                // NOTE: In a real app, you would fetch data here from the GitHub API.
                // Example REST endpoint: `https://api.github.com/repos/${repoOwner}/${repoName}`

                // Simulate data fetching and processing delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Mock Data for visualization
                const mockCommitData = Array.from({ length: 12 }, () => Math.floor(Math.random() * 500) + 100);
                const mockIssueData = Array.from({ length: 30 }, () => ({
                    open: Math.floor(Math.random() * 20) + 5,
                    closed: Math.floor(Math.random() * 10) + 2
                }));

                const openIssues = mockIssueData.reduce((acc, d) => acc + d.open, 0);
                const totalCommits = mockCommitData.reduce((a, b) => a + b, 0);
                const activeContributors = Math.floor(Math.random() * 50) + 5;


                // --- Update UI with fetched (mock) Data ---
                document.getElementById('current-repo-title').textContent = fullName;
                document.getElementById('repo-description').textContent = `Analysis complete. Showing real-time health metrics for the last 90 days.`;
                
                // Update KPIs
                document.getElementById('kpi-issues').textContent = openIssues.toLocaleString();
                document.getElementById('kpi-commits').textContent = totalCommits.toLocaleString();
                document.getElementById('kpi-contributors').textContent = activeContributors.toLocaleString();

                // Show watch button if not already watched
                const isWatched = watchedRepos.some(r => r.fullName.toLowerCase() === fullName.toLowerCase());
                const watchBtn = document.getElementById('add-to-watch-btn');
                if (!isWatched && isAuthReady) {
                    watchBtn.classList.remove('hidden');
                    watchBtn.dataset.owner = repoOwner;
                    watchBtn.dataset.repo = repoName;
                } else {
                    watchBtn.classList.add('hidden');
                }

                // Render Charts
                renderCommitActivityChart(mockCommitData);
                renderIssueFlowChart(mockIssueData);

            } catch (error) {
                document.getElementById('current-repo-title').textContent = `Error Loading ${fullName}`;
                document.getElementById('repo-description').textContent = `Could not fetch data. Check the repository name and your network connection.`;
                console.error("Error loading metrics:", error);
            }
        }

        /** Adds the currently viewed repository to the user's watched list in Firestore. */
        async function addToWatchedList() {
            if (!isAuthReady || !db || !userId) {
                console.warn("Firestore not ready or user not authenticated.");
                return;
            }

            const owner = document.getElementById('add-to-watch-btn').dataset.owner;
            const repo = document.getElementById('add-to-watch-btn').dataset.repo;

            if (!owner || !repo) return;

            try {
                const reposPath = `/artifacts/${appId}/users/${userId}/watched_repos`;
                await addDoc(collection(db, reposPath), {
                    owner: owner,
                    repo: repo,
                    last_viewed: new Date().toISOString()
                });
                console.log(`Added ${owner}/${repo} to watched list.`);
                document.getElementById('add-to-watch-btn').classList.add('hidden'); // Hide after successful add
            } catch (error) {
                console.error("Error adding to watched list:", error);
            }
        }

        /** Removes a repository from the user's watched list in Firestore. */
        async function removeWatchedRepo(docId, fullName) {
            if (!isAuthReady || !db || !userId) return;

            try {
                const reposPath = `/artifacts/${appId}/users/${userId}/watched_repos`;
                await deleteDoc(doc(db, reposPath, docId));
                console.log(`Removed ${fullName} from watched list.`);
            } catch (error) {
                console.error(`Error removing ${fullName}:`, error);
            }
        }


        let commitChartInstance = null;
        function renderCommitActivityChart(data) {
            if (commitChartInstance) commitChartInstance.destroy();

            const ctx = document.getElementById('commitActivityChart').getContext('2d');
            
            // Generate mock labels (Last 12 weeks)
            const labels = Array.from({ length: 12 }, (_, i) => `Week ${i + 1}`);

            commitChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Commits per Week',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue-500
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        let issueChartInstance = null;
        function renderIssueFlowChart(data) {
            if (issueChartInstance) issueChartInstance.destroy();

            const ctx = document.getElementById('issueFlowChart').getContext('2d');
            
            // Generate mock labels (Last 30 days)
            const labels = Array.from({ length: 30 }, (_, i) => `Day ${i + 1}`);
            const openData = data.map(d => d.open);
            const closedData = data.map(d => d.closed);

            issueChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Issues Opened',
                            data: openData,
                            borderColor: 'rgb(234, 88, 12)', // Orange-600
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Issues Closed',
                            data: closedData,
                            borderColor: 'rgb(22, 163, 74)', // Green-600
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // --- Start Application ---
        window.addEventListener('load', initializeFirebase);
    </script>

</body>
</html>
